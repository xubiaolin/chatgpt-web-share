import{d as A,P as C,Q as z,R as u,Y as W,e as H,r as S,V as l,k as ce,z as ue,U as c,G as i,c as U,X as V,a2 as Q,a3 as X,S as J,l as Se,w as Me,a4 as G,_ as ie}from"./vue-aaa0e4fd.js";import{a as de,b as ve,d as ze,c as _e,m as F,p as Ae,g as Re,u as Le,e as Be,l as q,f as Te,h as Ee}from"./index-39327448.js";import{g as He,_ as De}from"./HistoryContent.vue_vue_type_script_setup_true_lang-ee03a649.js";import{s as pe,t as Ve,N as O,a as N,g as Fe,v as Ue,b as je,i as Ne,j as Ie,w as Ke,x as Oe,k as fe,y as Pe,z as qe,A as me,B as K,C as We}from"./naive_ui-66407851.js";import{g as Ge}from"./status-11ac6561.js";const Qe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Xe=u("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 112v288"},null,-1),Je=u("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M400 256H112"},null,-1),Ye=[Xe,Je],Ze=A({name:"Add",render:function(a,n){return C(),z("svg",Qe,Ye)}}),et={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},tt=u("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48",d:"M112 268l144 144l144-144"},null,-1),nt=u("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48",d:"M256 392V100"},null,-1),ot=[tt,nt],lt=A({name:"ArrowDown",render:function(a,n){return C(),z("svg",et,ot)}}),st={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},at=u("path",{d:"M408 48H104a72.08 72.08 0 0 0-72 72v192a72.08 72.08 0 0 0 72 72h24v64a16 16 0 0 0 26.25 12.29L245.74 384H408a72.08 72.08 0 0 0 72-72V120a72.08 72.08 0 0 0-72-72zM160 248a32 32 0 1 1 32-32a32 32 0 0 1-32 32zm96 0a32 32 0 1 1 32-32a32 32 0 0 1-32 32zm96 0a32 32 0 1 1 32-32a32 32 0 0 1-32 32z",fill:"currentColor"},null,-1),rt=[at],it=A({name:"ChatboxEllipses",render:function(a,n){return C(),z("svg",st,rt)}}),ct={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ut=u("path",{d:"M475 64H37C16.58 64 0 81.38 0 102.77v306.42C0 430.59 16.58 448 37 448h438c20.38 0 37-17.41 37-38.81V102.77C512 81.38 495.42 64 475 64zM288 368h-64V256l-48 64l-48-64v112H64V144h64l48 80l48-80h64zm96 0l-80-112h48.05L352 144h64v112h48z",fill:"currentColor"},null,-1),dt=[ut],vt=A({name:"LogoMarkdown",render:function(a,n){return C(),z("svg",ct,dt)}}),_t={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},pt=u("path",{d:"M408 112H106a58 58 0 0 0-58 58v158a56 56 0 0 0 56 56h8v39.68A40.32 40.32 0 0 0 152.32 464h207.36A40.32 40.32 0 0 0 400 423.68V384h8a56 56 0 0 0 56-56V168a56 56 0 0 0-56-56zm-40 311.68a8.35 8.35 0 0 1-8.32 8.32H152.32a8.35 8.35 0 0 1-8.32-8.32V264.32a8.35 8.35 0 0 1 8.32-8.32h207.36a8.35 8.35 0 0 1 8.32 8.32zm26-215.76a24 24 0 1 1 22-22a24 24 0 0 1-22 22z",fill:"currentColor"},null,-1),ft=u("path",{d:"M344 48H168a56.09 56.09 0 0 0-55.42 48h286.84A56.09 56.09 0 0 0 344 48z",fill:"currentColor"},null,-1),mt=[pt,ft],wt=A({name:"Print",render:function(a,n){return C(),z("svg",_t,mt)}}),ht={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},gt=u("path",{d:"M476.59 227.05l-.16-.07L49.35 49.84A23.56 23.56 0 0 0 27.14 52A24.65 24.65 0 0 0 16 72.59v113.29a24 24 0 0 0 19.52 23.57l232.93 43.07a4 4 0 0 1 0 7.86L35.53 303.45A24 24 0 0 0 16 327v113.31A23.57 23.57 0 0 0 26.59 460a23.94 23.94 0 0 0 13.22 4a24.55 24.55 0 0 0 9.52-1.93L476.4 285.94l.19-.09a32 32 0 0 0 0-58.8z",fill:"currentColor"},null,-1),xt=[gt],yt=A({name:"Send",render:function(a,n){return C(),z("svg",ht,xt)}}),$t={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},bt=u("path",{d:"M392 432H120a40 40 0 0 1-40-40V120a40 40 0 0 1 40-40h272a40 40 0 0 1 40 40v272a40 40 0 0 1-40 40z",fill:"currentColor"},null,-1),kt=[bt],Ct=A({name:"Stop",render:function(a,n){return C(),z("svg",$t,kt)}}),St={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Mt=u("path",{d:"M9.31 17l2.44-2.44L14.19 17l1.06-1.06l-2.44-2.44l2.44-2.44L14.19 10l-2.44 2.44L9.31 10l-1.06 1.06l2.44 2.44l-2.44 2.44L9.31 17zM19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z",fill:"currentColor"},null,-1),zt=[Mt],At=A({name:"EventBusyFilled",render:function(a,n){return C(),z("svg",St,zt)}}),Rt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Lt=u("path",{d:"M6 14c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3c.55 0 1-.45 1-1s-.45-1-1-1H7v-2c0-.55-.45-1-1-1zm0-4c.55 0 1-.45 1-1V7h2c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1zm11 7h-2c-.55 0-1 .45-1 1s.45 1 1 1h3c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1s-1 .45-1 1v2zM14 6c0 .55.45 1 1 1h2v2c0 .55.45 1 1 1s1-.45 1-1V6c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1z",fill:"currentColor"},null,-1),Bt=[Lt],Tt=A({name:"FullscreenRound",render:function(a,n){return C(),z("svg",Rt,Bt)}}),Et={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Ht=u("path",{d:"M17.29 5.71a.996.996 0 0 0-1.41 0L12 9.58L8.11 5.7A.996.996 0 1 0 6.7 7.11l4.59 4.59c.39.39 1.02.39 1.41 0l4.59-4.59a.984.984 0 0 0 0-1.4z",fill:"currentColor"},null,-1),Dt=u("path",{d:"M17.29 12.3a.996.996 0 0 0-1.41 0L12 16.17l-3.88-3.88a.996.996 0 1 0-1.41 1.41l4.59 4.59c.39.39 1.02.39 1.41 0l4.59-4.59a.993.993 0 0 0-.01-1.4z",fill:"currentColor"},null,-1),Vt=[Ht,Dt],Ft=A({name:"KeyboardDoubleArrowDownRound",render:function(a,n){return C(),z("svg",Et,Vt)}}),Ut={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},jt=u("path",{d:"M6.7 18.29c.39.39 1.02.39 1.41 0L12 14.42l3.88 3.88a.996.996 0 1 0 1.41-1.41L12.7 12.3a.996.996 0 0 0-1.41 0L6.7 16.88a.996.996 0 0 0 0 1.41z",fill:"currentColor"},null,-1),Nt=u("path",{d:"M6.7 11.7c.39.39 1.02.39 1.41 0L12 7.83l3.88 3.88a.996.996 0 1 0 1.41-1.41L12.7 5.71a.996.996 0 0 0-1.41 0L6.7 10.29a.996.996 0 0 0 0 1.41z",fill:"currentColor"},null,-1),It=[jt,Nt],Kt=A({name:"KeyboardDoubleArrowUpRound",render:function(a,n){return C(),z("svg",Ut,It)}}),Ot={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Pt=u("path",{d:"M4 18h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zm0-5h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zM3 7c0 .55.45 1 1 1h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1z",fill:"currentColor"},null,-1),qt=[Pt],Wt=A({name:"MenuRound",render:function(a,n){return C(),z("svg",Ot,qt)}}),Gt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Qt=u("path",{d:"M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z",fill:"currentColor"},null,-1),Xt=[Qt],Jt=A({name:"QueueFilled",render:function(a,n){return C(),z("svg",Gt,Xt)}}),Yt={class:"flex w-full justify-center absolute -top-10"},Zt={class:"mx-2 flex flex-row space-x-2 py-2 justify-center relative"},en={class:"mx-4 mb-4 flex flex-row space-x-2"},tn=A({__name:"InputRegion",props:{canAbort:{type:Boolean},sendDisabled:{type:Boolean},inputValue:null,autoScrolling:{type:Boolean}},emits:["abort-request","send-msg","export-to-markdown-file","export-to-pdf-file","show-fullscreen-history","update:auto-scrolling","update:input-value"],setup(d,{emit:a}){const n=d,y=pe(),$=de(),{t:_}=W(),m=H({get(){return n.autoScrolling},set(e){a("update:auto-scrolling",e)}}),w=S(!1),k=H(()=>w.value?{height:"30vh"}:{height:"auto",maxHeight:"16vh"}),t=H({get(){return n.inputValue},set(e){a("update:input-value",e)}}),o=()=>{w.value=!w.value},p=e=>{const s=$.preference.sendKey;(s==="Enter"&&e.key==="Enter"&&!e.shiftKey&&!e.ctrlKey||s==="Shift+Enter"&&e.key==="Enter"&&e.shiftKey&&!e.ctrlKey||s==="Ctrl+Enter"&&e.key==="Enter"&&!e.shiftKey&&e.ctrlKey)&&(e.preventDefault(),a("send-msg"))};return(e,s)=>{const L=Ve,r=O,f=N,R=Fe,T=Ue,M=je;return C(),z("div",{class:"flex-shrink-0 flex flex-col align-middle relative z-10",style:X({background:i(y).baseColor})},[l(L),u("div",Yt,[ce(l(r,{secondary:"",strong:"",type:"error",size:"small",onClick:s[0]||(s[0]=h=>a("abort-request"))},{icon:c(()=>[l(i(Ct))]),default:c(()=>[U(" "+V(i(_)("commons.abortRequest")),1)]),_:1},512),[[ue,d.canAbort]])]),u("div",Zt,[l(r,{class:"absolute left-0 top-2",quaternary:"",circle:"",size:"small",onClick:o},{icon:c(()=>[l(f,{component:w.value?i(Ft):i(Kt)},null,8,["component"])]),_:1}),l(T,null,{trigger:c(()=>[l(R,{value:i(m),"onUpdate:value":s[1]||(s[1]=h=>Q(m)?m.value=h:null),size:"small",class:"absolute right-2 top-3"},{icon:c(()=>[U(" A ")]),_:1},8,["value"])]),default:c(()=>[U(" "+V(e.$t("tips.autoScrolling")),1)]),_:1}),l(r,{secondary:"",type:"info",size:"small",onClick:s[2]||(s[2]=h=>a("show-fullscreen-history"))},{icon:c(()=>[l(f,{size:22},{default:c(()=>[l(i(Tt))]),_:1})]),_:1}),l(r,{secondary:"",type:"primary",size:"small",onClick:s[3]||(s[3]=h=>a("export-to-markdown-file"))},{icon:c(()=>[l(f,null,{default:c(()=>[l(i(vt))]),_:1})]),_:1}),l(r,{secondary:"",type:"warning",size:"small",onClick:s[4]||(s[4]=h=>a("export-to-pdf-file"))},{icon:c(()=>[l(f,null,{default:c(()=>[l(i(wt))]),_:1})]),_:1})]),u("div",en,[l(M,{ref:"inputRef",value:i(t),"onUpdate:value":s[6]||(s[6]=h=>Q(t)?t.value=h:null),class:"flex-1",type:"textarea",bordered:!0,placeholder:e.$t("tips.sendMessage",[i($).preference.sendKey]),autosize:{minRows:1},style:X(i(k)),onKeydown:p},{suffix:c(()=>[l(r,{disabled:d.sendDisabled,text:"",class:"",type:"primary",size:"small",onClick:s[5]||(s[5]=h=>a("send-msg"))},{icon:c(()=>[l(f,null,{default:c(()=>[l(i(yt))]),_:1})]),_:1},8,["disabled"])]),_:1},8,["value","placeholder","style"])])],4)}}});const nn={class:"flex flex-row justify-between content-center"},on={class:"flex flex-row justify-between content-center"},ln=A({__name:"StatusCard",setup(d){W();const a=S({}),n=S(!1),y=_=>{_.length>0?(n.value=!0,$()):n.value=!1},$=()=>{n.value&&Ge().then(_=>{a.value=_.data})};return $(),setInterval($,5e3),(_,m)=>{const w=N,k=Ne,t=Ie,o=Ke,p=Oe,e=fe;return C(),J(e,{"content-style":"padding: 0;"},{default:c(()=>[l(p,{"onUpdate:expandedNames":y},{default:c(()=>[l(o,{title:_.$t("commons.serverStatus"),name:"serverStatus"},{default:c(()=>[l(t,{hoverable:"","show-divider":""},{default:c(()=>[l(k,null,{default:c(()=>[u("div",nn,[u("div",null,[l(w,{class:"mr-1"},{default:c(()=>[l(i(At))]),_:1}),U(V(_.$t("commons.isChatbotBusy")),1)]),u("div",null,V(a.value.is_chatbot_busy?_.$t("commons.yes"):_.$t("commons.no")),1)])]),_:1}),l(k,null,{default:c(()=>[u("div",on,[u("div",null,[l(w,{class:"mr-1"},{default:c(()=>[l(i(Jt))]),_:1}),U(V(_.$t("commons.chatbotWaitingCount")),1)]),u("div",null,V(a.value.chatbot_waiting_count),1)])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})]),_:1})}}});const sn={class:"flex-grow flex flex-col"},an=A({__name:"LeftBar",props:{loading:{type:Boolean},value:null,newConv:null},emits:["update:value","new-conversation"],setup(d,{emit:a}){const n=d,{t:y}=W(),$=ve(),_=H({get(){return n.value},set(t){a("update:value",t)}}),m=H(()=>{var p;const t=(p=$.conversations)==null?void 0:p.slice().sort((e,s)=>{if(!e.create_time)return-1;if(!s.create_time)return 1;const L=new Date(e.create_time);return new Date(s.create_time).getTime()-L.getTime()}),o=t==null?void 0:t.map(e=>({label:()=>Se(Pe,null,{default:()=>e.title}),key:e.conversation_id,disabled:n.loading==!0,extra:()=>ze(e,w,k)}));return n.newConv&&(o==null||o.unshift({label:n.newConv.title,key:n.newConv.conversation_id,disabled:n.loading==!0})),o}),w=t=>{if(!t)return;const o=_e.info({title:y("commons.confirmDialogTitle"),content:y("tips.deleteConversation"),positiveText:y("commons.confirm"),negativeText:y("commons.cancel"),onPositiveClick:()=>(o.loading=!0,new Promise(p=>{$.deleteConversation(t).then(()=>{F.success(y("tips.deleteConversationSuccess")),_.value==t&&(_.value=null)}).catch(()=>{F.error(y("tips.deleteConversationFailed"))}).finally(()=>{o.loading=!1,p(!0)})}))})},k=t=>{t&&Ae(t,async o=>{await $.changeConversationTitle(t,o)},()=>{F.success(y("tips.changeConversationTitleSuccess"))},()=>{F.error(y("tips.changeConversationTitleFailed"))})};return(t,o)=>{const p=N,e=O,s=qe,L=me;return C(),z("div",null,[l(ln),u("div",sn,[l(e,{secondary:"",strong:"",type:"primary",disabled:n.loading,onClick:o[0]||(o[0]=r=>a("new-conversation"))},{icon:c(()=>[l(p,{class:""},{default:c(()=>[l(i(Ze))]),_:1})]),default:c(()=>[U(" "+V(t.$t("commons.newConversation")),1)]),_:1},8,["disabled"]),l(L,{class:"h-0 flex-grow mt-4"},{default:c(()=>[l(s,{ref:"menuRef",value:i(_),"onUpdate:value":o[1]||(o[1]=r=>Q(_)?_.value=r:null),class:"-mx-2","content-style":{backgroundColor:"red"},disabled:n.loading,options:i(m),"root-indent":18},null,8,["value","disabled","options"])]),_:1})])])}}});var Y={},rn={get exports(){return Y},set exports(d){Y=d}};(function(d,a){(function(n,y){y()})(K,function(){function n(t,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\uFEFF",t],{type:t.type}):t}function y(t,o,p){var e=new XMLHttpRequest;e.open("GET",t),e.responseType="blob",e.onload=function(){k(e.response,o,p)},e.onerror=function(){console.error("could not download file")},e.send()}function $(t){var o=new XMLHttpRequest;o.open("HEAD",t,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function _(t){try{t.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(o)}}var m=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof K=="object"&&K.global===K?K:void 0,w=m.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),k=m.saveAs||(typeof window!="object"||window!==m?function(){}:"download"in HTMLAnchorElement.prototype&&!w?function(t,o,p){var e=m.URL||m.webkitURL,s=document.createElement("a");o=o||t.name||"download",s.download=o,s.rel="noopener",typeof t=="string"?(s.href=t,s.origin===location.origin?_(s):$(s.href)?y(t,o,p):_(s,s.target="_blank")):(s.href=e.createObjectURL(t),setTimeout(function(){e.revokeObjectURL(s.href)},4e4),setTimeout(function(){_(s)},0))}:"msSaveOrOpenBlob"in navigator?function(t,o,p){if(o=o||t.name||"download",typeof t!="string")navigator.msSaveOrOpenBlob(n(t,p),o);else if($(t))y(t,o,p);else{var e=document.createElement("a");e.href=t,e.target="_blank",setTimeout(function(){_(e)})}}:function(t,o,p,e){if(e=e||open("","_blank"),e&&(e.document.title=e.document.body.innerText="downloading..."),typeof t=="string")return y(t,o,p);var s=t.type==="application/octet-stream",L=/constructor/i.test(m.HTMLElement)||m.safari,r=/CriOS\/[\d]+/.test(navigator.userAgent);if((r||s&&L||w)&&typeof FileReader<"u"){var f=new FileReader;f.onloadend=function(){var M=f.result;M=r?M:M.replace(/^data:[^;]*;/,"data:attachment/file;"),e?e.location.href=M:location=M,e=null},f.readAsDataURL(t)}else{var R=m.URL||m.webkitURL,T=R.createObjectURL(t);e?e.location=T:location.href=T,e=null,setTimeout(function(){R.revokeObjectURL(T)},4e4)}});m.saveAs=k.saveAs=k,d.exports=k})})(rn);const cn=(d,a)=>{let n=`# ${d.title}

`;const y=new Date(d.create_time?d.create_time+"Z":new Date).toLocaleString();n+=`Date: ${y}
Model: ${Re(d.model_name)}
`,n+=`---

`;let $=0;for(const m of a)if(m.author_role==="user"){let w=m.message.trim().split(`
`)[0];w.length>=50&&(w=w.slice(0,47)+"..."),n+=`## ${++$}. ${w}

`,n+=`### User

${m.message}

`}else n+=`### ChatGPT

${m.message}

`,n+=`---

`;const _=new Blob([n],{type:"text/plain;charset=utf-8"});Y.saveAs(_,`${d.title} - ChatGPT history.md`)},un={class:"left-3 top-3 absolute z-20"},dn={class:"right-2 bottom-5 absolute z-20"},wn=A({__name:"index",setup(d){const a=pe(),{t:n}=W(),y=S(),$=S(),_=Le(),m=de(),w=ve(),k=S(!1),t=S(!1),o=S(!0),p=S(!1),e=S(!1),s=S(Be("foldLeftBar",!1));let L=null;const r=S(null),f=S(null),R=H(()=>{var v,x;return((v=r.value)==null?void 0:v.conversation_id)===f.value?r.value:(x=w.conversations)==null?void 0:x.find(D=>D.conversation_id==f.value)}),T=S(""),M=S(null),h=S(null),Z=H(()=>{const g=f.value;if(!g)return[];let v=He(g);return te.value.length>0&&(v=v.concat(te.value)),v}),ee=H(()=>{var g,v,x;if((g=R.value)!=null&&g.conversation_id)return(x=w.conversationDetailMap[(v=R.value)==null?void 0:v.conversation_id])==null?void 0:x.current_node}),te=H(()=>{const g=[];return M.value&&g.findIndex(v=>{var x;return v.id===((x=M.value)==null?void 0:x.id)})===-1&&g.push(M.value),h.value&&g.findIndex(v=>{var x;return v.id===((x=h.value)==null?void 0:x.id)})===-1&&g.push(h.value),g});Me(f,(g,v)=>{g!="new_conversation"&&we(g)});const we=g=>{k.value||!g||(k.value=!0,t.value=!0,q.start(),w.fetchConversationHistory(g).then(()=>{}).catch(v=>{console.log(v)}).finally(()=>{k.value=!1,t.value=!1,q.finish()}))},ne=H(()=>k.value||f.value==null||T.value===null||T.value.trim()==""),oe=()=>{r.value||Te(async(g,v)=>{var x;r.value={conversation_id:"new_conversation",title:g||`New Chat ${new Date().toLocaleString()} - ${(x=_.user)==null?void 0:x.username}`,model_name:v||"text-davinci-002-render-sha",create_time:new Date().toISOString()},f.value="new_conversation"})},he=()=>{L==null||!e.value||(L(),L=null)},ge=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},xe=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},ye=async()=>{var le;if(ne.value||k.value){F.error(n("tips.pleaseSelectConversation"));return}q.start(),k.value=!0;const g=T.value;T.value="",e.value=!1,p.value=!1;let v=!1;const x={message:g};r.value?(x.new_title=r.value.title,x.model_name=r.value.model_name):(x.conversation_id=R.value.conversation_id,x.parent_id=ee.value);const D=Math.random().toString(36).substring(2,16);M.value={id:`send_${D}`,message:g,author_role:"user",parent:ee.value,children:[`recv_${D}`]},h.value={id:`recv_${D}`,message:"",author_role:"assistent",parent:`send_${D}`,children:[],typing:!0,model_slug:(le=R.value)==null?void 0:le.model_name};const P=Ee();let B=null;console.log("Connecting to",P,x);const j=new WebSocket(P);j.onopen=E=>{j.send(JSON.stringify(x))},j.onmessage=E=>{const b=JSON.parse(E.data);b.type&&(b.type==="waiting"?(e.value=!1,h.value.message=n(b.tip)):b.type==="queueing"?(e.value=!0,h.value.message=n(b.tip)):b.type==="message"?(v=!0,h.value.message=b.message,h.value.id=b.parent_id,h.value.model_slug=b.model_name,r.value&&(r.value.model_name=b.model_name,r.value.conversation_id!==b.conversation_id&&(r.value.conversation_id=b.conversation_id),f.value!==r.value.conversation_id&&(f.value=r.value.conversation_id)),e.value=!0):b.type==="error"&&(h.value.message=`${n(b.tip)}: ${b.message}}`,console.error(b.tip,b.message),b.message&&(B=b.message)),o.value&&ge())},j.onclose=async E=>{if(L=null,e.value=!1,h.value.typing=!1,console.log("WebSocket connection is closed",E,p.value),p.value||E.code===1e3){if(v)if(r.value){const b=new Date(r.value.create_time).getTime()/1e3,se={id:f.value,title:r.value.title,model_name:r.value.model_name,create_time:b,mapping:{},current_node:null};w.$patch({conversationDetailMap:{[r.value.conversation_id]:se}});const ae=M.value,re=h.value;M.value=null,h.value=null,w.addMessageToConversation(f.value,ae,re),f.value=r.value.conversation_id,await w.fetchAllConversations(),r.value=null,console.log("done",se,ae,re,f.value)}else h.value.id.startsWith("recv")||w.addMessageToConversation(f.value,M.value,h.value),M.value=null,h.value=null}else _e.error({title:n("errors.askError"),content:B!=null?`[${E.code}] ${n(E.reason)}: ${B}`:`[${E.code}] ${n(E.reason)}`,positiveText:n("commons.withdrawMessage"),negativeText:n("commons.cancel"),onPositiveClick:()=>{M.value=null,h.value=null}});await _.fetchUserInfo(),q.finish(),k.value=!1,p.value=!1},j.onerror=E=>{console.error("WebSocket error:",E)},L=()=>{p.value=!0,j.close()}},$e=()=>{if(!R.value){F.error(n("tips.pleaseSelectConversation"));return}cn(R.value,Z.value)},I=S(),be=S(!1),ke=()=>{if(!R.value){F.error(n("tips.pleaseSelectConversation"));return}I.value.focus(),I.value.toggleFullscreenHistory(!0)},Ce=()=>{if(!R.value){F.error(n("tips.pleaseSelectConversation"));return}I.value.toggleFullscreenHistory(!1),window.print(),I.value.toggleFullscreenHistory(!1)};return w.fetchAllConversations().then(),(g,v)=>{const x=me,D=We,P=fe;return C(),z("div",{ref_key:"rootRef",ref:y,class:G(["flex-grow flex flex-col md:flex-row",i(m).preference.widerConversationPage?"":"lg:w-screen-lg lg:mx-auto"])},[ce(l(an,{value:f.value,"onUpdate:value":v[0]||(v[0]=B=>f.value=B),class:G(["md:min-w-50 pl-4 lt-md:pr-4 box-border mb-4 lt-md:h-56 md:flex-grow overflow-hidden flex flex-col space-y-4",i(m).preference.widerConversationPage?"md:w-1/5":"md:w-1/4"]),loading:k.value,"new-conv":r.value,onNewConversation:oe},null,8,["value","class","loading","new-conv"]),[[ue,!s.value]]),u("div",{class:G(["flex-grow flex flex-col md:px-4",i(m).preference.widerConversationPage?"md:w-4/5":"md:w-3/4"])},[l(P,{class:"flex-grow md:mb-4 relative",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column; "},{default:c(()=>[u("div",un,[l(i(O),{strong:"",secondary:"",type:s.value?"default":"primary",size:"small",onClick:v[1]||(v[1]=B=>s.value=!s.value)},{icon:c(()=>[l(i(N),{component:i(Wt)},null,8,["component"])]),_:1},8,["type"])]),f.value?(C(),J(x,{key:0,ref_key:"historyRef",ref:$,class:"basis-0 flex-grow shrink-grow relative",style:{"overflow-y":"scroll","-webkit-overflow-scrolling":"touch"},"content-style":t.value?{height:"100%"}:{}},{default:c(()=>{var B;return[u("div",dn,[l(i(O),{secondary:"",circle:"",size:"small",onClick:xe},{icon:c(()=>[l(i(N),{component:i(lt)},null,8,["component"])]),_:1})]),l(De,{ref_key:"historyContentRef",ref:I,messages:i(Z),fullscreen:!1,"model-name":((B=i(R))==null?void 0:B.model_name)||"","show-tips":be.value,loading:t.value},null,8,["messages","model-name","show-tips","loading"])]}),_:1},8,["content-style"])):f.value?ie("",!0):(C(),z("div",{key:1,class:"flex-grow flex flex-col justify-center",style:X({backgroundColor:i(a).cardColor})},[i(R)?ie("",!0):(C(),J(D,{key:0,description:g.$t("tips.loadConversation")},{icon:c(()=>[l(i(N),null,{default:c(()=>[l(i(it))]),_:1})]),extra:c(()=>[l(i(O),{onClick:oe},{default:c(()=>[U(V(g.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),l(tn,{"input-value":T.value,"onUpdate:inputValue":v[2]||(v[2]=B=>T.value=B),"auto-scrolling":o.value,"onUpdate:autoScrolling":v[3]||(v[3]=B=>o.value=B),"can-abort":e.value,"send-disabled":i(ne),onAbortRequest:he,onExportToMarkdownFile:$e,onExportToPdfFile:Ce,onSendMsg:ye,onShowFullscreenHistory:ke},null,8,["input-value","auto-scrolling","can-abort","send-disabled"])]),_:1})],2)],2)}}});export{wn as default};
//# sourceMappingURL=index-36cb2d12.js.map
